<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>React Project</title>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script> -->
    <!-- <link rel="stylesheet" href="style.css" /> -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
     <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      "use strict";
      const { useState, useEffect, useMemo } = React;
      const Header = () => {
        return (
          <div className="container mt-3 mb-5">
            <section className="hero is-link">
              <div className="hero-body">
                <p className="title">Link hero</p>
                <p className="subtitle">Link subtitle</p>
              </div>
            </section>
          </div>
        );
      };
      const Footer = () => {
        return (
          <div className="container mb-3">
            <footer className="footer">
              <div className="content has-text-centered">
                <p>
                  <strong>Bulma</strong> by{" "}
                  <a href="https://jgthms.com">Jeremy Thomas</a>. The source code is
                  licensed
                  <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.
                  The website content is licensed{" "}
                  <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                    CC BY NC SA 4.0
                  </a>
                  .
                </p>
              </div>
            </footer>
          </div>
        );
      };
      const Form = () => {
        // フォームデータの初期値
        const defaultValuesOfFormData = {
          boardName: "Unselected",
          deviceId: 0,
          macAddress: "",
          localIpAddress: "",
          localSubnetMaskAddress: "",
          localGatewayAddress: "",
          useDhcp: false,
          wifiSsid: "",
          wifiPass: "",
          otherIpAddress: "",
          otherPortNum: 0,
          advancedSettingsFlg: false,
          numOfSample: 256,
          transmissionIntervalMs: 10000,
        };
        const [formData, setFormData] = useState(defaultValuesOfFormData);

        // バリデーションチェック結果のエラーメッセージ格納
        const [errorOfData, setErrorOfData] = useState({
          boardName: "",
          deviceId: "",
          macAddress: "",
          localIpAddress: "",
          localSubnetMaskAddress: "",
          localGatewayAddress: "",
          useDhcp: "",
          wifiSsid: "",
          wifiPass: "",
          otherIpAddress: "",
          otherPortNum: "",
          advancedSettingsFlg: "",
          numOfSample: "",
          transmissionIntervalMs: "",
        });

        // バリデーションチェック関数
        const validation = (name, value) => {
          let check;
          switch (name) {
            case "boardName":
              switch (value) {
                case "ESP32":
                  setErrorOfData({ ...errorOfData, [name]: "" });
                  console.log("ESP32が選択されました");
                  break;
                case "RasberryPi pico":
                  setErrorOfData({ ...errorOfData, [name]: "" });
                  console.log("RasberryPi picoが選択されました");
                  break;
                default:
                  setErrorOfData({
                    ...errorOfData,
                    [name]: "ボードを選択してください",
                  });
                  console.log("ボードを選択してください");
                  break;
              }
              break;
            case "deviceId":
              // デバイスIDのバリデーションチェックを行う
              check = /^([0-9]|[1-9][0-9])$/.test(value)
                ? ""
                : "0-99の間で入力してください";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "macAddress":
              // MACアドレスのバリデーションチェックを行う
              check = /(?:[0-9a-fA-F]{2}\:){5}[0-9a-fA-F]{2}/.test(value)
                ? ""
                : "コロンを使用した形式で入力してください";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "localIpAddress":
              // 自局IPアドレスのバリデーションチェックを行う
              check =
                /^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$/.test(
                  value
                )
                  ? ""
                  : "形式に誤りがあります";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "localSubnetMaskAddress":
              // 自局サブネットマスクのバリデーションチェックを行う
              check =
                /^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$/.test(
                  value
                )
                  ? ""
                  : "形式に誤りがあります";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "localGatewayAddress":
              // 自局ゲートウェイのバリデーションチェックを行う
              if (value) {
                check =
                  /^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$/.test(
                    value
                  )
                    ? ""
                    : "形式に誤りがあります";
              } else {
                // ゲートウェイは省略可能
                check = "";
              }
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "useDhcp":
              // DHCPを使うかどうかのバリデーションチェックを行う
              check = /^(true|false)$/.test(String(value))
                ? ""
                : "形式に誤りがあります";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "wifiSsid":
              // Wi-FiのSSIDのバリデーションチェックを行う
              check = /^[!-~]{1,32}$/.test(String(value))
                ? ""
                : "ASCIIで32文字以内で入力してください。";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "wifiPass":
              // Wi-Fiのパスワードのバリデーションチェックを行う
              check = /^[!-~]{1,100}$/.test(String(value))
                ? ""
                : "ASCIIで100文字以内で入力してください。";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "otherIpAddress":
              // 他局IPアドレスのバリデーションチェックを行う
              check =
                /^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$/.test(
                  value
                )
                  ? ""
                  : "形式に誤りがあります";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "otherPortNum":
              // 他局ポート番号のバリデーションチェックを行う
              check = /^50[0-1][0-9]{2}$/.test(value)
                ? ""
                : "50000-50199の範囲で入力してください";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "advancedSettingFlg":
              // Advanced Settingsフラグのバリデーションチェックを行う
              check = /^(true|false)$/.test(String(value))
                ? ""
                : "形式に誤りがあります";
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "numOfSample":
              // サンプル数のバリデーションチェックを行う (required: advanced Settings Flg is True)
              if (formData.advancedSettingsFlg) {
                check = /^(32|64|128|256|512|1024|2048|4096)$/
                  ? ""
                  : "形式に誤りがあります";
              } else if (
                String(formData.numOfSample) !==
                String(defaultValuesOfFormData.numOfSample)
              ) {
                check = "Advanced Settings Flgがtrueになっていません";
              } else {
                check = "";
              }
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} error: ${check}`
              );
              break;
            case "transmissionIntervalMs":
              // 送信間隔のバリデーションチェックを行う (required: advanced Settings)
              // サンプル数に応じて送信間隔の数値チェックを行う
              if (formData.advancedSettingsFlg) {
                switch (true) {
                  case !/^[0-9]+$/.test(value):
                    check = "数字で入力してください";
                    break;
                  case Number(value) < 1000:
                    check = "1000ms以上で指定してください";
                    break;
                  case Number(value) > 300000:
                    check = "300000ms（5分）以内で指定してください";
                    break;
                  case Number(value) >= 1000 && Number(value) < 300001:
                    check = "";
                    break;
                  default:
                    check = "不明なエラー";
                    break;
                }
              } else if (
                value !== String(defaultValuesOfFormData.transmissionIntervalMs)
              ) {
                check = "Advanced Settings Flgがtrueになっていません";
              } else {
                check = "";
              }
              setErrorOfData({ ...errorOfData, [name]: check });
              console.log(
                `(validation check) name: ${name} value: ${value} typeOfValue: ${typeof value} error: ${check}`
              );
              break;
          }
        };

        const handleInputChange = (event) => {
          const target = event.target;
          const value = target.type === "checkbox" ? target.checked : target.value;
          const name = target.name; // inputにname属性必要
          setFormData({
            ...formData,
            [name]: value,
          });
          console.log(`(handle input Change) name: ${name}, value:${value}`);
        };
        const handleInputBlur = (event) => {
          const target = event.target;
          const value = target.type === "checkbox" ? target.checked : target.value;
          const name = target.name;
          validation(name, value);
        };
        const handleSubmit = (event) => {
          event.preventDefault();
          alert("Submit");
        };
        const handleKeyPress = (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            // alert('Pressed Enter Key');
          };
        };

        const formOfAdvancedSettings = useMemo(() => {
          const numOfSampleOptions = [];
          for (let i = 5; i < 13; i++) {
            numOfSampleOptions.push({
              value: 2 ** i,
              label: String(2 ** i),
            });
          }
          // console.log(numOfSampleOptions);
          return (
            <>
              <div className="field">
                <label className="label">サンプル数 N</label>
                <div className="control">
                  <div className="select">
                    <select
                      name="numOfSample"
                      value={formData.numOfSample}
                      onChange={handleInputChange}
                      onBlur={handleInputBlur}
                    >
                      {numOfSampleOptions.map(({ value, label }, index) => (
                        <option key={index} value={value}>
                          {label}
                        </option>
                      ))}
                    </select>
                  </div>
                  {errorOfData.numOfSample && (
                    <span className="has-text-danger-dark">
                      {errorOfData.numOfSample}
                    </span>
                  )}
                </div>
              </div>
              <div className="field">
                <label className="label">データ送信間隔 (millisec)</label>
                <div className="control">
                  <input
                    name="transmissionIntervalMs"
                    className="input"
                    type="number"
                    placeholder="Number input"
                    style={{ width: "50%" }}
                    value={formData.transmissionIntervalMs}
                    onChange={handleInputChange}
                    onBlur={handleInputBlur}
                    onKeyPress={handleKeyPress}
                  />
                </div>
                {errorOfData.transmissionIntervalMs && (
                  <span className="has-text-danger-dark">
                    {errorOfData.transmissionIntervalMs}
                  </span>
                )}
              </div>
            </>
          );
        }, [
          formData.advancedSettingsFlg,
          formData.numOfSample,
          formData.transmissionIntervalMs,
          errorOfData.numOfSample,
          errorOfData.transmissionIntervalMs,
        ]);

        return (
          <div className="container box">
            <p className="mt-3 ml-4 is-size-5 has-text-weight-semibold">
              設定フォーム
            </p>
            <form onSubmit={handleSubmit}>
              <div className="columns mt-3 mx-3 is-centered">
                <div className="column is-one-third">
                  <div className="field">
                    <label className="label">Select Board</label>
                    <div className="control">
                      <div className="select">
                        <select
                          name="boardName"
                          value={formData.boardName}
                          onChange={handleInputChange}
                          onBlur={handleInputBlur}
                        >
                          <option value="Unselected">-- Select Board --</option>
                          <option value="ESP32">ESP32</option>
                          <option value="RasberryPi pico">RasberryPi pico</option>
                        </select>
                        {errorOfData.boardName && (
                          <span className="has-text-danger-dark">
                            {errorOfData.boardName}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
                <div className="column is-1" />
                <div className="column is-one-third">
                  <div className="field">
                    <label className="label">Device ID</label>
                    <div className="control">
                      <input
                        name="deviceId"
                        className="input"
                        type="number"
                        placeholder="Device ID"
                        max="99"
                        style={{ width: "33%" }}
                        value={formData.deviceId}
                        onChange={handleInputChange}
                        onBlur={handleInputBlur}
                        onKeyPress={handleKeyPress}
                        disabled={formData.boardName === "Unselected"}
                      />
                    </div>
                    {errorOfData.deviceId && (
                      <span className="has-text-danger-dark">
                        {errorOfData.deviceId}
                      </span>
                    )}
                  </div>
                </div>
              </div>

              <div className="columns mx-3 is-centered">
                <div className="column is-one-third">
                  {formData.boardName === "RasberryPi pico" && (
                    <div className="field">
                      <label className="label">Macアドレス</label>
                      <div className="control">
                        <input
                          name="macAddress"
                          className="input"
                          type="text"
                          placeholder="Text input"
                          value={formData.macAddress}
                          onChange={handleInputChange}
                          onBlur={handleInputBlur}
                          onKeyPress={handleKeyPress}
                          disabled={formData.boardName === "Unselected"}
                        />
                        {errorOfData.macAddress && (
                          <span className="has-text-danger-dark">
                            {errorOfData.macAddress}
                          </span>
                        )}
                      </div>
                    </div>
                  )}

                  <div className="field">
                    <label className="label">自局IPアドレス</label>
                    <div className="control">
                      <input
                        name="localIpAddress"
                        className="input"
                        type="text"
                        placeholder="Text input"
                        value={formData.localIpAddress}
                        onChange={handleInputChange}
                        onBlur={handleInputBlur}
                        onKeyPress={handleKeyPress}
                        disabled={
                          formData.useDhcp || formData.boardName === "Unselected"
                        }
                      />
                      {errorOfData.localIpAddress && (
                        <span className="has-text-danger-dark">
                          {errorOfData.localIpAddress}
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="field">
                    <label className="label">自局サブネットマスク</label>
                    <div className="control">
                      <input
                        name="localSubnetMaskAddress"
                        className="input"
                        type="text"
                        placeholder="Text input"
                        value={formData.localSubnetMaskAddress}
                        onChange={handleInputChange}
                        onBlur={handleInputBlur}
                        onKeyPress={handleKeyPress}
                        disabled={
                          formData.useDhcp || formData.boardName === "Unselected"
                        }
                      />
                      {errorOfData.localSubnetMaskAddress && (
                        <span className="has-text-danger-dark">
                          {errorOfData.localSubnetMaskAddress}
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="field">
                    <label className="label">
                      自局ゲートウェイアドレス（省略可能）
                    </label>
                    <div className="control">
                      <input
                        name="localGatewayAddress"
                        className="input"
                        type="text"
                        placeholder="Text input"
                        value={formData.localGatewayAddress}
                        onChange={handleInputChange}
                        onBlur={handleInputBlur}
                        onKeyPress={handleKeyPress}
                        disabled={
                          formData.useDhcp || formData.boardName === "Unselected"
                        }
                      />
                      {errorOfData.localGatewayAddress && (
                        <span className="has-text-danger-dark">
                          {errorOfData.localGatewayAddress}
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="field">
                    <div className="control">
                      <label className="checkbox">
                        <input
                          name="useDhcp"
                          type="checkbox"
                          value={formData.useDhcp}
                          onChange={handleInputChange}
                          onBlur={handleInputBlur}
                          onKeyPress={handleKeyPress}
                          disabled={formData.boardName === "Unselected"}
                        />
                        <span className="ml-2 is-size-6">DHCPを使用する</span>
                        {formData.boardName === "ESP32" && (
                          <span className="ml-1 has-text-warning-dark">
                            （ESP32非推奨）
                          </span>
                        )}
                      </label>
                    </div>
                    {errorOfData.useDhcp && (
                      <span className="has-text-danger-dark">
                        {errorOfData.useDhcp}
                      </span>
                    )}
                  </div>
                </div>
                <div className="column is-1" />

                <div className="column is-one-third">
                  <div className="field">
                    <label className="label">他局IPアドレス</label>
                    <div className="control">
                      <input
                        name="otherIpAddress"
                        className="input"
                        type="text"
                        placeholder="Text input"
                        value={formData.otherIpAddress}
                        onChange={handleInputChange}
                        onBlur={handleInputBlur}
                        onKeyPress={handleKeyPress}
                        disabled={formData.boardName === "Unselected"}
                      />
                      {errorOfData.otherIpAddress && (
                        <span className="has-text-danger-dark">
                          {errorOfData.otherIpAddress}
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="field">
                    <label className="label">他局ポート番号</label>
                    <div className="control">
                      <input
                        name="otherPortNum"
                        className="input"
                        type="number"
                        placeholder="Number input"
                        style={{ width: "33%" }}
                        value={formData.otherPortNum}
                        onChange={handleInputChange}
                        onBlur={handleInputBlur}
                        onKeyPress={handleKeyPress}
                        disabled={formData.boardName === "Unselected"}
                      />
                    </div>
                    {errorOfData.otherPortNum && (
                      <span className="has-text-danger-dark">
                        {errorOfData.otherPortNum}
                      </span>
                    )}
                  </div>

                  {formData.boardName === "ESP32" && (
                    <>
                      <div className="field">
                        <label className="label">Wi-Fi SSID</label>
                        <div className="control">
                          <input
                            name="wifiSsid"
                            className="input"
                            type="text"
                            placeholder="Text input"
                            value={formData.wifiSsid}
                            onChange={handleInputChange}
                            onBlur={handleInputBlur}
                            onKeyPress={handleKeyPress}
                          />
                          {errorOfData.wifiSsid && (
                            <span className="has-text-danger-dark">
                              {errorOfData.wifiSsid}
                            </span>
                          )}
                        </div>
                      </div>

                      <div className="field">
                        <label className="label">Wi-Fi Password</label>
                        <div className="control">
                          <input
                            name="wifiPass"
                            className="input"
                            type="text"
                            placeholder="Text input"
                            value={formData.wifiPass}
                            onChange={handleInputChange}
                            onBlur={handleInputBlur}
                            onKeyPress={handleKeyPress}
                          />
                          {errorOfData.wifiPass && (
                            <span className="has-text-danger-dark">
                              {errorOfData.wifiPass}
                            </span>
                          )}
                        </div>
                      </div>
                    </>
                  )}

                  <div className="field">
                    <div className="control">
                      <label className="checkbox">
                        <input
                          name="advancedSettingsFlg"
                          type="checkbox"
                          value={formData.advancedSettingsFlg}
                          onChange={handleInputChange}
                          onBlur={handleInputBlur}
                          onKeyPress={handleKeyPress}
                          disabled={formData.boardName === "Unselected"}
                        />
                        <span className="ml-2 is-size-6">
                          Enable Advanced Settings
                        </span>
                      </label>
                      {errorOfData.advancedSettingsFlg && (
                        <span className="has-text-danger-dark">
                          {errorOfData.advancedSettingsFlg}
                        </span>
                      )}
                    </div>
                  </div>

                  {formData.advancedSettingsFlg && formOfAdvancedSettings}
                </div>
              </div>

              <div className="columns mx-3 is-centered">
                <div className="column is-one-fifth">
                  <div className="field mt-3 mb-3 ml-4">
                    <div className="control">
                      <button className="button is-link">Submit</button>
                    </div>
                  </div>
                </div>
                <div className="column is-1" />
                <div className="column is-half" />
              </div>
            </form>
          </div>
        );
      };

      // 参考: https://zenn.dev/nawomat/articles/f8be31b66bfc19
      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(
        <>
          <Header />
          <Form />
          <Footer />
        </>
      );
    </script>
</html>
